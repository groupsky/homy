# Test overlay for monitoring pipeline E2E test
# Removes external port mappings since tests run inside containers
# Uses Docker managed volumes for complete isolation between test runs

services:
  broker:
    ports: !reset []  # Remove port mappings for internal testing
  
  influxdb:
    ports: !reset []  # Remove port mappings for internal testing
  
  grafana:
    ports: !reset []  # Remove port mappings for internal testing
  
  # mqtt-influx-automation inherits FLUSH_IMMEDIATELY=true from .env.test
  
  # Test runner container with internal network access
  test-runner:
    image: node:18-alpine
    working_dir: /usr/src/test
    networks:
      - automation
    environment:
      - BROKER=mqtt://broker:1883
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_DATABASE=homy
      - GRAFANA_URL=http://grafana:3000
    depends_on:
      - broker
      - influxdb
      - grafana
      - mqtt-influx-automation
    command: tail -f /dev/null  # Keep container running

# Docker managed volumes for test isolation
# These are automatically destroyed when containers are removed
volumes:
  grafana-test-data:
  influxdb-test-data:
  mongo-test-data:

