# Test overlay for monitoring pipeline E2E test
# This completely removes external port mappings since tests run inside containers

services:
  broker:
    ports: !reset []  # Completely remove all port mappings
  
  influxdb:
    ports: !reset []  # Completely remove all port mappings
    environment:
      - INFLUXDB_HTTP_AUTH_ENABLED=false  # Disable auth for testing
  
  grafana:
    ports: !reset []  # Completely remove all port mappings
    volumes:
      # Override provisioning to disable problematic alert rules
      - /dev/null:/etc/grafana/provisioning/alerting/bath-lights-alerts.yaml:ro
  
  mqtt-influx-automation:
    # Remove secrets since we disabled InfluxDB auth
    secrets: !reset []
    environment:
      - BROKER=mqtt://broker
      - TOPIC=homy/automation/+/command_failed
      - MQTT_CLIENT_ID=mqtt-influx-automation
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_DATABASE=homy
      - INFLUXDB_USERNAME=  # Empty for no auth
      - INFLUXDB_PASSWORD=  # Empty for no auth
  
  # Add a test runner container that can access services via internal network
  test-runner:
    image: node:18-alpine
    working_dir: /usr/src/test
    networks:
      - automation
    environment:
      - BROKER=mqtt://broker:1883
      - INFLUXDB_URL=http://influxdb:8086
      - GRAFANA_URL=http://grafana:3000
      - INFLUXDB_DATABASE=homy
    depends_on:
      - broker
      - influxdb
      - grafana
      - mqtt-influx-automation
    command: tail -f /dev/null  # Keep container running