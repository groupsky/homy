# Test overlay for monitoring pipeline E2E test
# Removes external port mappings since tests run inside containers
# Uses isolated test data directories (via DATA_PATH=./data.test) and local test secrets

services:
  broker:
    ports: !reset []  # Remove port mappings for internal testing
  
  influxdb:
    ports: !reset []  # Remove port mappings for internal testing
  
  grafana:
    ports: !reset []  # Remove port mappings for internal testing
  
  # Enable immediate flushing for E2E testing
  mqtt-influx-automation:
    environment:
      - BROKER=mqtt://broker
      - TOPIC=homy/automation/+/command_failed
      - MQTT_CLIENT_ID=mqtt-influx-automation
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_USERNAME_FILE=/run/secrets/influxdb_write_user
      - INFLUXDB_PASSWORD_FILE=/run/secrets/influxdb_write_user_password
      - INFLUXDB_DATABASE=homy
      - TAGS={"component":"automation"}
      - FLUSH_IMMEDIATELY=true  # Enable immediate flush for E2E testing
  
  # Test runner container with internal network access
  test-runner:
    image: node:18-alpine
    working_dir: /usr/src/test
    networks:
      - automation
    environment:
      - BROKER=mqtt://broker:1883
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_DATABASE=homy
      - GRAFANA_URL=http://grafana:3000
    depends_on:
      - broker
      - influxdb
      - grafana
      - mqtt-influx-automation
    command: tail -f /dev/null  # Keep container running

