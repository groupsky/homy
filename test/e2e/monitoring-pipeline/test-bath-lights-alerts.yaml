apiVersion: 1

contactPoints:
  - orgId: 1
    name: telegram-bath-lights
    receivers:
      - uid: telegram-bath-lights
        type: webhook
        disableResolveMessage: false
        settings:
          # Test webhook pointing to mock server
          url: http://test-runner:8080/webhook
          httpMethod: POST
          maxAlerts: 0
          title: "Bath Lights Alert"

policies:
  - orgId: 1
    receiver: telegram-bath-lights
    group_by:
      - service
      - severity
    group_wait: 10s
    group_interval: 30s
    repeat_interval: 4h
    matchers:
      - service = bath-lights

groups:
  - orgId: 1
    name: bath-lights-alerts
    folder: alerting
    interval: $BATH_LIGHTS_ALERT_INTERVAL
    rules:
      - uid: bath-lights-command-failures
        title: Bath Lights Command Failures
        condition: B
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: P3C6603E967DC8568
            model:
              datasource:
                type: influxdb
                uid: P3C6603E967DC8568
              query: 'SELECT count("attempts") FROM "command_failure" WHERE ("controller" = ''lightBath1Controller'') AND time >= now() - 5m'
              rawQuery: true
              resultFormat: time_series
          - refId: B
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
        noDataState: NoData
        execErrState: Alerting
        for: $BATH_LIGHTS_ALERT_FOR
        annotations:
          description: 'Bath lights controller has command failures in the last 5 minutes'
          summary: 'Bath lights command failures detected'
        labels:
          service: bath-lights
          severity: warning