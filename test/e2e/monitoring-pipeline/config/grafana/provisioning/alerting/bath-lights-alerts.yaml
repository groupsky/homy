# Test-specific Grafana alerting configuration with fast timing for E2E tests
# This overrides the production configuration for faster test feedback

contactPoints:
  - orgId: 1
    name: telegram-bath-lights
    receivers:
      - uid: telegram-bath-lights
        type: telegram
        disableResolveMessage: false
        settings:
          chatid: |
            $TELEGRAM_CHAT_ID
          bottoken: "$TELEGRAM_BOT_TOKEN"
          message: |
            🏠 <b>{{ .GroupLabels.service | title }} Alert</b>

            <b>Status:</b> {{ .Status | title }}
            <b>Severity:</b> {{ .GroupLabels.severity | title }}

            {{ range .Alerts }}
            📋 <b>{{ .Annotations.summary }}</b>
            📊 {{ .Annotations.description }}

            🔗 <a href="{{ .GeneratorURL }}">View Dashboard</a>
            📖 <a href="{{ .Annotations.runbook_url }}">Troubleshooting Guide</a>
            {{ end }}

            ⏰ {{ .CommonAnnotations.timestamp }}
          parseMode: HTML
          uploadImage: false

policies:
  - orgId: 1
    receiver: telegram-bath-lights
    group_by:
      - service
    group_wait: 10s
    group_interval: 10s
    repeat_interval: 1m
    matchers:
      - service = bath-lights

groups:
  - orgId: 1
    name: bath-lights-alerts
    folder: alerting
    interval: 10s  # Fast evaluation for tests
    rules:
      - uid: bath-lights-command-failures
        title: Bath Lights Command Failures
        condition: B
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 30  # 30 seconds lookback for tests
              to: 0
            datasourceUid: P3C6603E967DC8568
            model:
              datasource:
                type: influxdb
                uid: P3C6603E967DC8568
              query: 'SELECT count("attempts") FROM "command_failure" WHERE ("controller" = ''lightBath1Controller'') AND time >= now() - 30s'
              rawQuery: true
              resultFormat: time_series
          - refId: B
            queryType: ''
            relativeTimeRange:
              from: 30
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
        noDataState: NoData
        execErrState: Alerting
        for: 5s  # Fire quickly for tests
        annotations:
          description: 'Bath lights controller has command failures in the last 30 seconds'
          summary: Bath lights command verification failure detected
        labels:
          service: bath-lights
          severity: warning