name: Unit Tests

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  # ============================================================================
  # Automation Events Processor Tests
  # ============================================================================
  test-automation-events-processor:
    name: Test automation-events-processor
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run when automation-events-processor files change
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.modified, 'docker/automation-events-processor/') ||
      contains(github.event.head_commit.added, 'docker/automation-events-processor/') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/automation-events-processor/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/automation-events-processor/package-lock.json'

      - name: Install dependencies
        working-directory: docker/automation-events-processor
        run: npm ci

      - name: Run tests
        working-directory: docker/automation-events-processor
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/automation-events-processor/coverage
          flags: automation-events-processor

  # ============================================================================
  # Automations Tests
  # ============================================================================
  test-automations:
    name: Test automations
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run when automations files change
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.modified, 'docker/automations/') ||
      contains(github.event.head_commit.added, 'docker/automations/') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/automations/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/automations/package-lock.json'

      - name: Install dependencies
        working-directory: docker/automations
        run: npm ci

      - name: Run tests
        working-directory: docker/automations
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/automations/coverage
          flags: automations

  # ============================================================================
  # Modbus Serial Tests
  # ============================================================================
  test-modbus-serial:
    name: Test modbus-serial
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run when modbus-serial files change
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.modified, 'docker/modbus-serial/') ||
      contains(github.event.head_commit.added, 'docker/modbus-serial/') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/modbus-serial/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/modbus-serial/package-lock.json'

      - name: Install dependencies
        working-directory: docker/modbus-serial
        run: npm ci

      - name: Run tests
        working-directory: docker/modbus-serial
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/modbus-serial/coverage
          flags: modbus-serial

  # ============================================================================
  # Sunseeker Monitoring Tests
  # ============================================================================
  test-sunseeker-monitoring:
    name: Test sunseeker-monitoring
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run when sunseeker-monitoring files change
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.modified, 'docker/sunseeker-monitoring/') ||
      contains(github.event.head_commit.added, 'docker/sunseeker-monitoring/') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/sunseeker-monitoring/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/sunseeker-monitoring/package-lock.json'

      - name: Install dependencies
        working-directory: docker/sunseeker-monitoring
        run: npm ci

      - name: Run tests
        working-directory: docker/sunseeker-monitoring
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/sunseeker-monitoring/coverage
          flags: sunseeker-monitoring

  # ============================================================================
  # Telegram Bridge Tests
  # ============================================================================
  test-telegram-bridge:
    name: Test telegram-bridge
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run when telegram-bridge files change
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.modified, 'docker/telegram-bridge/') ||
      contains(github.event.head_commit.added, 'docker/telegram-bridge/') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/telegram-bridge/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/telegram-bridge/package-lock.json'

      - name: Install dependencies
        working-directory: docker/telegram-bridge
        run: npm ci

      - name: Run tests
        working-directory: docker/telegram-bridge
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/telegram-bridge/coverage
          flags: telegram-bridge
