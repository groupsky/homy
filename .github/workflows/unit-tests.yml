name: Unit Tests

on:
  push:
    branches:
      - master
    paths:
      - 'docker/*/package.json'
      - 'docker/*/package-lock.json'
      - 'docker/**/*.js'
      - 'docker/**/*.ts'
      - 'docker/**/jest.config.js'
      - 'docker/**/.nvmrc'
      - '.github/workflows/unit-tests.yml'
  pull_request:
    paths:
      - 'docker/*/package.json'
      - 'docker/*/package-lock.json'
      - 'docker/**/*.js'
      - 'docker/**/*.ts'
      - 'docker/**/jest.config.js'
      - 'docker/**/.nvmrc'
      - '.github/workflows/unit-tests.yml'
  workflow_dispatch:

jobs:
  detect-testable-services:
    name: Detect Services with Tests
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Detect services with test scripts
        id: detect
        run: |
          echo "Detecting services with test scripts..."

          SERVICES='[]'

          # Find all services with package.json
          for service_dir in docker/*/; do
            SERVICE=$(basename "$service_dir")

            # Skip if no package.json
            if [ ! -f "$service_dir/package.json" ]; then
              echo "⏭️  Skipping $SERVICE (no package.json)"
              continue
            fi

            # Check if package.json has a test script
            if jq -e '.scripts.test' "$service_dir/package.json" > /dev/null 2>&1; then
              # Check if it's not the default placeholder
              TEST_SCRIPT=$(jq -r '.scripts.test' "$service_dir/package.json")
              if [[ "$TEST_SCRIPT" == *"no test specified"* ]]; then
                echo "⏭️  Skipping $SERVICE (placeholder test script)"
              else
                echo "✅ Found test script in $SERVICE"
                SERVICES=$(echo "$SERVICES" | jq --arg svc "$SERVICE" '. + [$svc]')
              fi
            else
              echo "⏭️  Skipping $SERVICE (no test script)"
            fi
          done

          # Compact JSON to single line for GitHub Actions output
          SERVICES_COMPACT=$(echo "$SERVICES" | jq -c .)

          echo "services=$SERVICES_COMPACT" >> $GITHUB_OUTPUT
          echo ""
          echo "Services with tests: $SERVICES"

  test-service:
    name: Test ${{ matrix.service }}
    needs: detect-testable-services
    if: needs.detect-testable-services.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-testable-services.outputs.services) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/${{ matrix.service }}/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/${{ matrix.service }}/package-lock.json'

      - name: Install dependencies
        working-directory: docker/${{ matrix.service }}
        run: npm ci

      - name: Run linting
        working-directory: docker/${{ matrix.service }}
        run: |
          if jq -e '.scripts.lint' package.json > /dev/null 2>&1; then
            echo "Running linter..."
            npm run lint
          else
            echo "No lint script found, skipping"
          fi
        continue-on-error: true

      - name: Run tests with coverage
        working-directory: docker/${{ matrix.service }}
        run: |
          # Detect test command
          if jq -e '.scripts["test:coverage"]' package.json > /dev/null 2>&1; then
            echo "Running: npm run test:coverage"
            npm run test:coverage
          elif jq -e '.scripts.test' package.json > /dev/null 2>&1; then
            echo "Running: npm test -- --coverage"
            npm test -- --coverage
          else
            echo "::error::No test script found"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/${{ matrix.service }}/coverage
          flags: ${{ matrix.service }}
          fail_ci_if_error: false

  summary:
    name: Unit Tests Summary
    needs: [detect-testable-services, test-service]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "=== Unit Tests Summary ==="
          echo ""
          echo "Services tested: ${{ needs.detect-testable-services.outputs.services }}"
          echo "Test job result: ${{ needs.test-service.result }}"
          echo ""

          if [ "${{ needs.test-service.result }}" == "failure" ]; then
            echo "❌ Some tests failed"
            exit 1
          elif [ "${{ needs.test-service.result }}" == "success" ]; then
            echo "✅ All tests passed"
          else
            echo "⏭️  Tests skipped or cancelled"
          fi
