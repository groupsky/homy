name: infrastructure

on: [ push, pull_request ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate resolved compose config
        run: |
          docker compose --env-file example.env --file docker-compose.yml config > resolved-docker-compose.yml

      - name: Build all containers
        uses: docker/bake-action@v6
        with:
          source: .
          files: |
            ./resolved-docker-compose.yml
          set: |
            *.cache-from=type=gha,scope=infrastructure
            *.cache-to=type=gha,mode=max,scope=infrastructure,ignore-error=true
          load: true

      - name: Start containers
        run: |
          docker compose --env-file example.env --file docker-compose.yml up --force-recreate --no-start

      - name: Validate ingress template generation
        run: |
          echo "Starting test backend services for ingress validation..."
          docker compose --env-file example.env up -d grafana ha

          echo "Starting ingressgen to generate nginx config..."
          docker compose --env-file example.env up -d ingressgen

          echo "Waiting for config generation..."
          for i in {1..30}; do
            if [ -f data/ingress/default.conf ] && [ -s data/ingress/default.conf ]; then
              echo "✓ Config file generated after $i seconds"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERROR: nginx config was not generated after 30 seconds"
              docker compose --env-file example.env logs ingressgen
              exit 1
            fi
            sleep 1
          done

          echo "Checking for upstream blocks..."
          if ! grep -q "upstream" data/ingress/default.conf; then
            echo "ERROR: No upstream blocks found in generated config"
            cat data/ingress/default.conf
            exit 1
          fi
          echo "✓ Upstream blocks found"

          echo "Checking upstream blocks are not empty..."
          awk '/^upstream /,/^}/' data/ingress/default.conf > upstreams.txt
          if grep -q "upstream" upstreams.txt && ! grep -q "server" upstreams.txt; then
            echo "ERROR: Upstream blocks exist but contain no server entries"
            cat upstreams.txt
            cat data/ingress/default.conf
            exit 1
          fi
          echo "✓ Upstream blocks contain server entries"
          cat upstreams.txt

          echo "Starting nginx and validating syntax..."
          docker compose --env-file example.env up -d ingress

          echo "Waiting for nginx to start..."
          for i in {1..15}; do
            if docker compose --env-file example.env ps ingress | grep -q "Up"; then
              echo "✓ Nginx container started after $i seconds"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "ERROR: Nginx container failed to start after 15 seconds"
              docker compose --env-file example.env logs ingress
              exit 1
            fi
            sleep 1
          done

          docker compose --env-file example.env exec -T ingress nginx -t
          echo "✓ Nginx config syntax is valid"

          echo "Checking ingressgen logs for critical errors..."
          docker compose --env-file example.env logs ingressgen
          echo "✓ Ingress template validation complete"
