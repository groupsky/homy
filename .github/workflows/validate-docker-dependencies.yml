name: Validate Docker Dependencies

on:
  push:
    paths:
      - 'docker/*/Dockerfile'
      - '.github/workflows/validate-docker-dependencies.yml'
  pull_request:
    paths:
      - 'docker/*/Dockerfile'
      - '.github/workflows/validate-docker-dependencies.yml'

jobs:
  validate-docker-base-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Validate all services use GHCR base images
        run: |
          echo "Validating that all services use ghcr.io/groupsky/homy/* base images..."

          # Find all Dockerfiles in docker/ subdirectories
          dockerfiles=$(find docker -mindepth 2 -name "Dockerfile" -type f)

          errors=0

          for dockerfile in $dockerfiles; do
            service=$(dirname "$dockerfile" | cut -d/ -f2)
            echo ""
            echo "Checking $service..."

            # Extract all FROM lines (including multi-stage builds)
            from_lines=$(grep "^FROM " "$dockerfile")

            while IFS= read -r line; do
              # Skip FROM lines that reference previous stages (AS stagename)
              if echo "$line" | grep -q " AS "; then
                base_image=$(echo "$line" | awk '{print $2}')
              else
                base_image=$(echo "$line" | awk '{print $2}')
              fi

              # Check if it's a stage reference (lowercase, no slashes)
              if echo "$base_image" | grep -q "/"; then
                # It's an actual image, not a stage reference
                if ! echo "$base_image" | grep -q "^ghcr.io/groupsky/homy/"; then
                  echo "❌ ERROR: $service uses non-GHCR base image: $base_image"
                  echo "   All services must use base images from ghcr.io/groupsky/homy/*"
                  echo "   See base-images/README.md for available images"
                  errors=$((errors + 1))
                else
                  echo "✅ $base_image"
                fi
              fi
            done <<< "$from_lines"
          done

          if [ $errors -gt 0 ]; then
            echo ""
            echo "======================================================================"
            echo "❌ Found $errors service(s) using non-GHCR base images"
            echo "======================================================================"
            echo ""
            echo "All services must use base images from ghcr.io/groupsky/homy/*"
            echo ""
            echo "Available base images:"
            echo "  - ghcr.io/groupsky/homy/node:*-alpine (Node.js services)"
            echo "  - ghcr.io/groupsky/homy/node-ubuntu:* (Node.js with Ubuntu)"
            echo "  - ghcr.io/groupsky/homy/grafana:*"
            echo "  - ghcr.io/groupsky/homy/influxdb:*-alpine"
            echo "  - ghcr.io/groupsky/homy/mosquitto:*"
            echo "  - ghcr.io/groupsky/homy/mongo:*"
            echo "  - ghcr.io/groupsky/homy/nodered:*"
            echo "  - ghcr.io/groupsky/homy/telegraf:*-alpine"
            echo ""
            echo "See base-images/README.md for current versions and usage"
            echo ""
            exit 1
          fi

          echo ""
          echo "======================================================================"
          echo "✅ All services use GHCR base images correctly"
          echo "======================================================================"
