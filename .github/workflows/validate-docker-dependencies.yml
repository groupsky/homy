name: Validate Docker Dependencies

on:
  push:
    paths:
      - 'docker/*/Dockerfile'
      - '.github/workflows/validate-docker-dependencies.yml'
  pull_request:
    paths:
      - 'docker/*/Dockerfile'
      - '.github/workflows/validate-docker-dependencies.yml'

jobs:
  validate-ghcr-usage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Validate all services use GHCR base images
        run: |
          echo "üîç Validating Docker dependencies..."
          echo ""

          VALIDATION_FAILED=0

          # Get list of service Dockerfiles
          SERVICE_DOCKERFILES=($(find docker -name Dockerfile -type f | sort))

          if [ ${#SERVICE_DOCKERFILES[@]} -eq 0 ]; then
            echo "‚ùå No Dockerfiles found in docker/"
            exit 1
          fi

          echo "Found ${#SERVICE_DOCKERFILES[@]} service Dockerfiles"
          echo ""

          # Define approved base image patterns
          APPROVED_PATTERNS=(
            "ghcr.io/groupsky/homy/"
            "ghcr.io/home-assistant/"
          )

          # Check each Dockerfile
          echo "üìã Checking base images..."
          for dockerfile in "${SERVICE_DOCKERFILES[@]}"; do
            echo ""
            echo "Checking $dockerfile..."

            # Get FROM lines with registry references (containing : or /)
            # This excludes multi-stage build stage references like "FROM base AS build"
            FROM_IMAGES=$(grep "^FROM " "$dockerfile" | awk '{print $2}' | grep -E '[/:]')

            if [ -z "$FROM_IMAGES" ]; then
              echo "  ‚ö†Ô∏è  No base image references found"
              continue
            fi

            # Check each base image
            while IFS= read -r image; do
              echo "  Image: $image"

              # Check if image matches any approved pattern
              APPROVED=false
              for pattern in "${APPROVED_PATTERNS[@]}"; do
                if [[ "$image" == "$pattern"* ]]; then
                  APPROVED=true
                  break
                fi
              done

              if [ "$APPROVED" = true ]; then
                echo "  ‚úÖ Approved base image"
              else
                echo "  ‚ùå INVALID: Must use ghcr.io/groupsky/homy/* base images"
                echo "     Current: $image"
                echo "     Expected patterns:"
                echo "       - ghcr.io/groupsky/homy/* (all services)"
                echo "       - ghcr.io/home-assistant/* (Home Assistant only)"
                VALIDATION_FAILED=1
              fi
            done <<< "$FROM_IMAGES"
          done

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "‚ùå Docker dependencies validation failed!"
            echo ""
            echo "All services must use ghcr.io/groupsky/homy/* base images to avoid"
            echo "Docker Hub rate limits (200 pulls/6h). See base-images/README.md for"
            echo "available base images."
            echo ""
            echo "Available base images (auto-discovered from base-images/):"

            # Dynamically discover available base images
            for base_image_dir in base-images/*/; do
              if [ -f "$base_image_dir/Dockerfile" ]; then
                # Extract image name from directory
                image_name=$(basename "$base_image_dir")

                # Extract version from Dockerfile's FROM line
                version=$(grep "^FROM " "$base_image_dir/Dockerfile" | head -1 | awk '{print $2}' | cut -d: -f2)

                # Determine GHCR image name based on directory
                case "$image_name" in
                  node-18-alpine|node-22-alpine)
                    ghcr_name="ghcr.io/groupsky/homy/node:$version"
                    ;;
                  node-ubuntu)
                    ghcr_name="ghcr.io/groupsky/homy/node-ubuntu:$version"
                    ;;
                  *)
                    ghcr_name="ghcr.io/groupsky/homy/$image_name:$version"
                    ;;
                esac

                echo "  - $ghcr_name"
              fi
            done

            echo ""
            echo "For new base images, see base-images/CLAUDE.md"
            exit 1
          fi

          echo "‚úÖ All service Dockerfiles use approved base images!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
