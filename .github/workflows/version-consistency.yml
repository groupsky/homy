name: Version Consistency Check

on:
  pull_request:
    paths:
      - 'docker/**/Dockerfile'
      - 'docker/**/.nvmrc'
      - '.github/workflows/version-consistency.yml'
  push:
    branches:
      - master
    paths:
      - 'docker/**/Dockerfile'
      - 'docker/**/.nvmrc'

permissions:
  contents: read

jobs:
  detect-services:
    name: Detect Services with .nvmrc
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Detect services with .nvmrc
        id: detect
        run: |
          SERVICES=()
          for NVMRC_FILE in docker/**/.nvmrc; do
            if [ -f "$NVMRC_FILE" ]; then
              SERVICE_DIR=$(dirname "$NVMRC_FILE")
              SERVICE_NAME=$(basename "$SERVICE_DIR")
              SERVICES+=("\"$SERVICE_NAME\"")
            fi
          done

          # Convert to JSON array
          SERVICES_JSON="[$(IFS=,; echo "${SERVICES[*]}")]"
          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "Found services: $SERVICES_JSON"

  check-versions:
    name: Version Check (${{ matrix.service }})
    needs: detect-services
    if: needs.detect-services.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-services.outputs.services) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Check .nvmrc and Dockerfile versions match
        working-directory: docker/${{ matrix.service }}
        run: |
          echo "=== Version Consistency Check for ${{ matrix.service }} ==="

          # Validate .nvmrc exists and has valid format
          if [ ! -f .nvmrc ]; then
            echo "::error::.nvmrc not found for ${{ matrix.service }}"
            exit 1
          fi

          NVMRC_VERSION=$(cat .nvmrc | tr -d '[:space:]')
          echo ".nvmrc version: $NVMRC_VERSION"

          # Reject lts/* format
          if [[ "$NVMRC_VERSION" == lts/* ]]; then
            echo "::error::.nvmrc contains 'lts/*' which is not allowed. Use explicit version (e.g., '18.20.8')"
            exit 1
          fi

          # Extract version from FINAL Dockerfile stage
          # Look for the last FROM line with node: or node-<variant>: to get the final stage base
          # Supports both standard (node:) and variant (node-ubuntu:, node-alpine:, node-slim:) patterns
          #
          # REGEX EXPLANATION:
          #   Pattern: node(-[a-z]+)?:
          #     - Matches: node:18.20.8-alpine (standard)
          #     - Matches: node-ubuntu:18.12.1 (variant with hyphen prefix)
          #     - Does NOT match: node:18.20.8-bookworm (Debian codename suffix - not currently needed)
          #
          #   Extraction: sed -E 's/.*node(-[a-z]+)?:([0-9.]+).*/\2/'
          #     - Group 1: Optional variant name (-ubuntu, -alpine, etc.)
          #     - Group 2: Version number (returned)
          #     - Example: node-ubuntu:18.12.1 → extracts "18.12.1"
          #
          DOCKERFILE_VERSION=$(grep -E "^FROM.*node(-[a-z]+)?:" Dockerfile | tail -1 | sed -E 's/.*node(-[a-z]+)?:([0-9.]+).*/\2/')
          echo "Dockerfile version: $DOCKERFILE_VERSION"

          if [ -z "$DOCKERFILE_VERSION" ]; then
            echo "::error::Could not extract Node.js version from Dockerfile"
            exit 1
          fi

          if [ "$NVMRC_VERSION" != "$DOCKERFILE_VERSION" ]; then
            echo "::error::Version mismatch detected!"
            echo "  .nvmrc:     $NVMRC_VERSION"
            echo "  Dockerfile: $DOCKERFILE_VERSION"
            echo ""
            echo "To fix this issue:"
            echo "  1. Update .nvmrc to match Dockerfile version, OR"
            echo "  2. Update Dockerfile FROM line to match .nvmrc version"
            exit 1
          fi

          echo "✅ Versions match: $NVMRC_VERSION"
