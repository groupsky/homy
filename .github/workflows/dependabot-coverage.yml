name: dependabot-coverage

on:
  push:
    paths:
      - '.github/dependabot.yml'
      - 'docker/*/Dockerfile'
      - 'docker/*/package.json'
      - '.github/workflows/dependabot-coverage.yml'
  pull_request:
    paths:
      - '.github/dependabot.yml'
      - 'docker/*/Dockerfile'
      - 'docker/*/package.json'
      - '.github/workflows/dependabot-coverage.yml'

jobs:
  validate-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Validate Dependabot YAML syntax
        run: |
          python3 -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))"
          echo "✅ Dependabot YAML syntax is valid"

      - name: Find all Docker services
        id: docker-services
        run: |
          # Find all directories with Dockerfiles (excluding node_modules)
          DOCKER_SERVICES=$(find docker -maxdepth 2 -name "Dockerfile" -not -path "*/node_modules/*" | sed 's|/Dockerfile||' | sed 's|^docker/||' | sort)
          echo "Found Docker services:"
          echo "$DOCKER_SERVICES"
          echo "docker_services<<EOF" >> $GITHUB_OUTPUT
          echo "$DOCKER_SERVICES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find all npm services
        id: npm-services
        run: |
          # Find all directories with package.json files (excluding node_modules)
          NPM_SERVICES=$(find docker -maxdepth 2 -name "package.json" -not -path "*/node_modules/*" | sed 's|/package.json||' | sed 's|^docker/||' | sort)
          echo "Found npm services:"
          echo "$NPM_SERVICES"
          echo "npm_services<<EOF" >> $GITHUB_OUTPUT
          echo "$NPM_SERVICES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract configured services from dependabot.yml
        id: configured-services
        run: |
          # Extract Docker ecosystem directories (exclude root "/" entries)
          DOCKER_CONFIGURED=$(grep -A2 'package-ecosystem: "docker"' .github/dependabot.yml | grep 'directory:' | sed 's/.*"\(.*\)".*/\1/' | sed 's|^/docker/||' | grep -v '^/$' | sort)
          echo "Configured Docker services:"
          echo "$DOCKER_CONFIGURED"
          echo "docker_configured<<EOF" >> $GITHUB_OUTPUT
          echo "$DOCKER_CONFIGURED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract npm ecosystem directories
          NPM_CONFIGURED=$(grep -A2 'package-ecosystem: "npm"' .github/dependabot.yml | grep 'directory:' | sed 's/.*"\(.*\)".*/\1/' | sed 's|^/docker/||' | sort)
          echo "Configured npm services:"
          echo "$NPM_CONFIGURED"
          echo "npm_configured<<EOF" >> $GITHUB_OUTPUT
          echo "$NPM_CONFIGURED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate Docker service coverage
        run: |
          DOCKER_SERVICES="${{ steps.docker-services.outputs.docker_services }}"
          DOCKER_CONFIGURED="${{ steps.configured-services.outputs.docker_configured }}"

          echo "Checking Docker service coverage..."
          MISSING=""
          for service in $DOCKER_SERVICES; do
            if ! echo "$DOCKER_CONFIGURED" | grep -q "^${service}$"; then
              echo "❌ Missing Docker entry for: $service"
              MISSING="$MISSING $service"
            else
              echo "✅ $service"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo ""
            echo "ERROR: The following Docker services are missing from dependabot.yml:"
            echo "$MISSING"
            exit 1
          fi

          echo ""
          echo "✅ All Docker services are covered by dependabot.yml"

      - name: Validate npm service coverage
        run: |
          NPM_SERVICES="${{ steps.npm-services.outputs.npm_services }}"
          NPM_CONFIGURED="${{ steps.configured-services.outputs.npm_configured }}"

          echo "Checking npm service coverage..."
          MISSING=""
          for service in $NPM_SERVICES; do
            if ! echo "$NPM_CONFIGURED" | grep -q "^${service}$"; then
              echo "❌ Missing npm entry for: $service"
              MISSING="$MISSING $service"
            else
              echo "✅ $service"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo ""
            echo "ERROR: The following npm services are missing from dependabot.yml:"
            echo "$MISSING"
            exit 1
          fi

          echo ""
          echo "✅ All npm services are covered by dependabot.yml"

      - name: Check for extra/orphaned entries
        run: |
          DOCKER_SERVICES="${{ steps.docker-services.outputs.docker_services }}"
          DOCKER_CONFIGURED="${{ steps.configured-services.outputs.docker_configured }}"
          NPM_SERVICES="${{ steps.npm-services.outputs.npm_services }}"
          NPM_CONFIGURED="${{ steps.configured-services.outputs.npm_configured }}"

          echo "Checking for orphaned Docker entries..."
          ORPHANED_DOCKER=""
          for service in $DOCKER_CONFIGURED; do
            if ! echo "$DOCKER_SERVICES" | grep -q "^${service}$"; then
              echo "⚠️  Orphaned Docker entry (no Dockerfile): $service"
              ORPHANED_DOCKER="$ORPHANED_DOCKER $service"
            fi
          done

          echo "Checking for orphaned npm entries..."
          ORPHANED_NPM=""
          for service in $NPM_CONFIGURED; do
            if ! echo "$NPM_SERVICES" | grep -q "^${service}$"; then
              echo "⚠️  Orphaned npm entry (no package.json): $service"
              ORPHANED_NPM="$ORPHANED_NPM $service"
            fi
          done

          if [ -n "$ORPHANED_DOCKER" ] || [ -n "$ORPHANED_NPM" ]; then
            echo ""
            echo "WARNING: Found orphaned entries in dependabot.yml"
            echo "These should be removed as the corresponding files don't exist:"
            [ -n "$ORPHANED_DOCKER" ] && echo "Docker: $ORPHANED_DOCKER"
            [ -n "$ORPHANED_NPM" ] && echo "npm: $ORPHANED_NPM"
            echo ""
            echo "Note: This is a warning, not an error. The workflow will continue."
          else
            echo ""
            echo "✅ No orphaned entries found"
          fi

      - name: Summary
        run: |
          echo "================================"
          echo "Dependabot Coverage Validation"
          echo "================================"
          echo "✅ YAML syntax valid"
          echo "✅ All Docker services covered"
          echo "✅ All npm services covered"
          echo "✅ Configuration is complete"
          echo "================================"
