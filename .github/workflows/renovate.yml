name: Renovate

on:
  # Run on schedule (weekly for base images, monthly check for services)
  schedule:
    - cron: '0 2 * * 1'  # Monday 2 AM UTC (base images check)
    - cron: '0 2 1 * *'  # First day of month 2 AM UTC (all dependencies)

  # Allow manual triggers
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Renovate log level'
        required: false
        default: 'debug'
        type: choice
        options:
          - debug
          - info
          - warn
          - error
      dryRun:
        description: 'Dry run mode (no PRs created)'
        required: false
        default: false
        type: boolean

  # Run on push to renovate config (for testing configuration changes)
  push:
    paths:
      - 'renovate.json'
      - '.github/workflows/renovate.yml'

jobs:
  renovate:
    name: Renovate Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Get Renovate app token
        id: get-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}

      - name: Run Renovate
        uses: renovatebot/github-action@v41.1.0
        with:
          configurationFile: renovate.json
          token: ${{ steps.get-token.outputs.token }}
        env:
          # Log level from workflow_dispatch or default to info
          LOG_LEVEL: ${{ inputs.logLevel || 'info' }}
          # Enable dry-run mode if requested
          RENOVATE_DRY_RUN: ${{ inputs.dryRun || 'false' }}
          # Platform configuration
          RENOVATE_PLATFORM: 'github'
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Autodiscover mode off (we specify repository explicitly)
          RENOVATE_AUTODISCOVER: 'false'
