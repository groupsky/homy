# CodeQL Advanced Security Analysis
# This workflow performs security and quality analysis on the codebase
# using GitHub's CodeQL engine to detect vulnerabilities and code quality issues.
#
# Supported languages in this repository:
# - JavaScript/TypeScript: Main application code, automations, MQTT services
# - Actions: GitHub Actions workflow files (security scanning for CI/CD pipelines)
#
# Query Suites:
# - security-and-quality: Comprehensive analysis including security vulnerabilities
#   and code quality issues (unused variables, duplicated code, inefficient logic)
#
# Actions Security Scanning (Public Preview):
# Detects workflow vulnerabilities including:
# - Script injection attacks (untrusted input in run commands)
# - Secrets exposure and credential leaks
# - Supply chain attack vectors (malicious actions, dependency confusion)
# - Insecure use of pull_request_target and other dangerous triggers
# - Privilege escalation and GITHUB_TOKEN misuse
#
# Learn more:
# - CodeQL overview: https://docs.github.com/en/code-security/code-scanning/introduction-to-code-scanning/about-code-scanning-with-codeql
# - Query suites: https://docs.github.com/en/code-security/code-scanning/managing-your-code-scanning-configuration/codeql-query-suites
# - Supported languages: https://codeql.github.com/docs/codeql-overview/supported-languages-and-frameworks/
# - Actions security: https://github.blog/security/application-security/how-to-secure-your-github-actions-workflows-with-codeql/
# - Actions queries: https://docs.github.com/en/code-security/code-scanning/managing-your-code-scanning-configuration/actions-built-in-queries
#
name: CodeQL

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run weekly on Monday at 20:29 UTC to catch new vulnerabilities
    - cron: '29 20 * * 1'

concurrency:
  # Cancel in-progress runs for the same workflow and ref (branch/PR)
  group: ${{ github.workflow }}-${{ github.ref }}
  # Cancel outdated scans when new commits are pushed to PRs (saves CI minutes)
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  # Required for code scanning to upload results
  security-events: write
  # Required for code scanning in private repositories
  contents: read
  # Required for workflow execution
  actions: read

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: javascript-typescript
            build-mode: none
          - language: actions
            build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1
      with:
        fetch-depth: 1

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: security-and-quality

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ matrix.language }}"
