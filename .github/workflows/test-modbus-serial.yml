name: Test Modbus Serial

on:
  push:
    branches:
      - master
    paths:
      - 'docker/modbus-serial/**'
      - '.github/workflows/test-modbus-serial.yml'
  pull_request:
    paths:
      - 'docker/modbus-serial/**'
      - '.github/workflows/test-modbus-serial.yml'
  workflow_dispatch:

jobs:
  test:
    name: Test modbus-serial
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: 'docker/modbus-serial/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'docker/modbus-serial/package-lock.json'

      - name: Install dependencies
        working-directory: docker/modbus-serial
        run: npm ci

      - name: Run tests
        working-directory: docker/modbus-serial
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        continue-on-error: true
        with:
          directory: docker/modbus-serial/coverage
          flags: modbus-serial
