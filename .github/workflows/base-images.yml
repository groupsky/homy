name: Build Base Images

on:
  push:
    branches: [master]
    paths:
      - 'base-images/**'
      - '.github/workflows/base-images.yml'
  pull_request:
    paths:
      - 'base-images/**'
      - '.github/workflows/base-images.yml'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract versions and generate tags
        id: prepare
        run: |
          cd base-images

          # Define base images with their directory, upstream pattern, and GHCR name
          declare -A images=(
            ["node-18-alpine"]="node: ghcr.io/groupsky/homy/node"
            ["node-22-alpine"]="node: ghcr.io/groupsky/homy/node"
            ["node-ubuntu"]="node: ghcr.io/groupsky/homy/node-ubuntu"
            ["grafana"]="grafana/grafana: ghcr.io/groupsky/homy/grafana"
            ["influxdb"]="influxdb: ghcr.io/groupsky/homy/influxdb"
            ["mosquitto"]="eclipse-mosquitto: ghcr.io/groupsky/homy/mosquitto"
            ["mongo"]="mongo: ghcr.io/groupsky/homy/mongo"
            ["nodered"]="nodered/node-red: ghcr.io/groupsky/homy/nodered"
            ["telegraf"]="telegraf: ghcr.io/groupsky/homy/telegraf"
          )

          TAGS=""
          echo "Extracted versions:"

          for dir in "${!images[@]}"; do
            IFS=' ' read -r pattern ghcr_name <<< "${images[$dir]}"

            # Extract version from Dockerfile
            version=$(grep "FROM $pattern" "$dir/Dockerfile" | cut -d: -f2)

            # Add to tags
            TAGS="${TAGS}${dir}.tags=${ghcr_name}:${version}"$'\n'

            echo "  $dir: $version → ${ghcr_name}:${version}"
          done

          # Output tags for bake action
          {
            echo "tags<<EOF"
            echo "$TAGS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Build base images (PR)
        if: github.event_name == 'pull_request'
        uses: docker/bake-action@v5
        with:
          workdir: base-images
          files: docker-bake.hcl
          push: false
          set: |
            ${{ steps.prepare.outputs.tags }}
            *.cache-from=type=gha,scope=base-images
            *.cache-to=type=gha,mode=max,scope=base-images,ignore-error=true

      - name: Build and push base images (master)
        if: github.event_name != 'pull_request'
        uses: docker/bake-action@v5
        with:
          workdir: base-images
          files: docker-bake.hcl
          push: true
          set: |
            ${{ steps.prepare.outputs.tags }}
            *.cache-from=type=gha,scope=base-images
            *.cache-to=type=gha,mode=max,scope=base-images,ignore-error=true

      - name: Verify images were built
        run: |
          echo "✅ Base images build completed successfully"
