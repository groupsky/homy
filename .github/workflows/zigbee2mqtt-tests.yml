name: Zigbee2MQTT Tests

on:
  push:
    paths:
      - 'docker/zigbee2mqtt/**'
      - 'base-images/zigbee2mqtt/**'
      - '.github/workflows/zigbee2mqtt-tests.yml'
  pull_request:
    paths:
      - 'docker/zigbee2mqtt/**'
      - 'base-images/zigbee2mqtt/**'
      - '.github/workflows/zigbee2mqtt-tests.yml'

jobs:
  docker-build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: docker/zigbee2mqtt/
          push: false
          load: true
          tags: zigbee2mqtt-test
          cache-from: type=gha,scope=zigbee2mqtt
          cache-to: type=gha,mode=max,scope=zigbee2mqtt,ignore-error=true

      - name: Create test secrets
        run: |
          mkdir -p test-secrets
          echo '[1,3,5,7,9,11,13,15,0,2,4,6,8,10,12,14]' > test-secrets/network_key
          echo 'tcp://127.0.0.1:6638' > test-secrets/serial_port
          echo 'zstack' > test-secrets/adapter
          echo 'test-token-12345' > test-secrets/frontend_auth_token

      - name: Test entrypoint wrapper with missing secrets
        run: |
          # Test that missing secrets are caught
          echo "Testing entrypoint wrapper validation..."

          # Should fail with missing required configuration
          docker run --rm \
            -e ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=z2m/test \
            -e ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://test-broker \
            zigbee2mqtt-test \
            /bin/sh -c "exit 0" 2>&1 | grep -q "ERROR: Required configuration missing" || {
              echo "Expected error for missing configuration but didn't get one"
              exit 1
            }

          echo "✅ Entrypoint wrapper correctly validates missing configuration"

      - name: Test entrypoint wrapper with valid secrets
        run: |
          echo "Testing entrypoint wrapper with valid secrets..."

          docker run --rm \
            -v $(pwd)/test-secrets:/run/secrets:ro \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_PORT_FILE=/run/secrets/serial_port \
            -e ZIGBEE2MQTT_CONFIG_ADVANCED_NETWORK_KEY_FILE=/run/secrets/network_key \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER_FILE=/run/secrets/adapter \
            -e ZIGBEE2MQTT_CONFIG_FRONTEND_AUTH_TOKEN_FILE=/run/secrets/frontend_auth_token \
            -e ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=z2m/test \
            -e ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://test-broker \
            zigbee2mqtt-test \
            /usr/local/bin/docker-entrypoint-wrapper.sh /bin/sh -c "echo 'Entrypoint validation passed'" 2>&1 | tee /tmp/output.log

          # Check for success messages
          grep -q "✅ Loaded ZIGBEE2MQTT_CONFIG_SERIAL_PORT" /tmp/output.log
          grep -q "✅ Loaded ZIGBEE2MQTT_CONFIG_ADVANCED_NETWORK_KEY" /tmp/output.log
          grep -q "✅ Loaded ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER" /tmp/output.log
          grep -q "✅ Loaded ZIGBEE2MQTT_CONFIG_FRONTEND_AUTH_TOKEN" /tmp/output.log
          grep -q "✅ All required configuration validated" /tmp/output.log

          echo "✅ Entrypoint wrapper correctly loads secrets and validates configuration"

      - name: Test entrypoint wrapper with empty secret file
        run: |
          echo "Testing entrypoint wrapper with empty secret file..."

          # Create empty secret file
          touch test-secrets/empty_secret

          # Should fail with empty file error
          docker run --rm \
            -v $(pwd)/test-secrets:/run/secrets:ro \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_PORT_FILE=/run/secrets/empty_secret \
            -e ZIGBEE2MQTT_CONFIG_ADVANCED_NETWORK_KEY_FILE=/run/secrets/network_key \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER_FILE=/run/secrets/adapter \
            -e ZIGBEE2MQTT_CONFIG_FRONTEND_AUTH_TOKEN_FILE=/run/secrets/frontend_auth_token \
            -e ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=z2m/test \
            -e ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://test-broker \
            zigbee2mqtt-test \
            /bin/sh -c "exit 0" 2>&1 | grep -q "ERROR: Secret file is empty" || {
              echo "Expected error for empty secret file but didn't get one"
              exit 1
            }

          echo "✅ Entrypoint wrapper correctly detects empty secret files"

      - name: Test entrypoint wrapper with missing secret file
        run: |
          echo "Testing entrypoint wrapper with missing secret file..."

          # Should fail with file not found error
          docker run --rm \
            -v $(pwd)/test-secrets:/run/secrets:ro \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_PORT_FILE=/run/secrets/nonexistent \
            -e ZIGBEE2MQTT_CONFIG_ADVANCED_NETWORK_KEY_FILE=/run/secrets/network_key \
            -e ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER_FILE=/run/secrets/adapter \
            -e ZIGBEE2MQTT_CONFIG_FRONTEND_AUTH_TOKEN_FILE=/run/secrets/frontend_auth_token \
            -e ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=z2m/test \
            -e ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://test-broker \
            zigbee2mqtt-test \
            /bin/sh -c "exit 0" 2>&1 | grep -q "ERROR: Secret file not found" || {
              echo "Expected error for missing secret file but didn't get one"
              exit 1
            }

          echo "✅ Entrypoint wrapper correctly detects missing secret files"

      - name: Test Docker healthcheck with running service
        run: |
          echo "Testing Docker healthcheck with running Zigbee2MQTT..."

          # Create a test docker-compose.yml that uses the healthcheck from the main file
          cat > docker-compose.test.yml <<EOF
          version: '3.8'
          services:
            mqtt-broker:
              image: eclipse-mosquitto:2
              command: mosquitto -c /mosquitto-no-auth.conf

            zigbee2mqtt-test:
              image: zigbee2mqtt-test
              depends_on:
                - mqtt-broker
              volumes:
                - $(pwd)/test-secrets:/run/secrets:ro
              environment:
                - ZIGBEE2MQTT_CONFIG_SERIAL_PORT_FILE=/run/secrets/serial_port
                - ZIGBEE2MQTT_CONFIG_ADVANCED_NETWORK_KEY_FILE=/run/secrets/network_key
                - ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER_FILE=/run/secrets/adapter
                - ZIGBEE2MQTT_CONFIG_FRONTEND_AUTH_TOKEN_FILE=/run/secrets/frontend_auth_token
                - ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=z2m/test
                - ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://mqtt-broker:1883
                - ZIGBEE2MQTT_CONFIG_FRONTEND_ENABLED=true
                - ZIGBEE2MQTT_CONFIG_FRONTEND_PORT=8080
                - ZIGBEE2MQTT_CONFIG_FRONTEND_HOST=0.0.0.0
              healthcheck:
          $(yq '.services.z2m-home1.healthcheck' docker-compose.yml | sed 's/^/        /')
          EOF

          echo "Test docker-compose.yml created with healthcheck:"
          cat docker-compose.test.yml

          # Start the services
          echo "Starting services with docker compose..."
          docker compose -f docker-compose.test.yml up -d

          # Wait for Docker's healthcheck to report status
          # start_period is 120s, so we wait up to 150s total
          echo "Waiting for Docker healthcheck to complete (up to 150 seconds)..."
          for i in {1..150}; do
            HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose -f docker-compose.test.yml ps -q zigbee2mqtt-test) 2>/dev/null || echo "starting")

            if [ "$HEALTH_STATUS" = "healthy" ]; then
              echo "✅ Container is healthy (after ${i}s)"
              break
            elif [ "$HEALTH_STATUS" = "unhealthy" ]; then
              echo "❌ Container is unhealthy after ${i}s"
              echo "Health status details:"
              docker inspect --format='{{json .State.Health}}' $(docker compose -f docker-compose.test.yml ps -q zigbee2mqtt-test) | jq .
              echo "Container logs:"
              docker compose -f docker-compose.test.yml logs zigbee2mqtt-test
              exit 1
            fi

            if [ $i -eq 150 ]; then
              echo "❌ Healthcheck did not report healthy within 150 seconds"
              echo "Final health status: $HEALTH_STATUS"
              docker inspect --format='{{json .State.Health}}' $(docker compose -f docker-compose.test.yml ps -q zigbee2mqtt-test) | jq .
              docker compose -f docker-compose.test.yml logs zigbee2mqtt-test
              exit 1
            fi

            if [ $((i % 15)) -eq 0 ]; then
              echo "Waiting for healthcheck... status: $HEALTH_STATUS (${i}s elapsed)"
            fi
            sleep 1
          done

          # Verify health details
          echo "Health check details:"
          docker inspect --format='{{json .State.Health}}' $(docker compose -f docker-compose.test.yml ps -q zigbee2mqtt-test) | jq .

          echo "✅ Docker healthcheck works correctly with running service"

          # Cleanup
          docker compose -f docker-compose.test.yml down -v || true
          rm docker-compose.test.yml || true

      - name: Cleanup
        if: always()
        run: |
          docker rmi zigbee2mqtt-test || true
          rm -rf test-secrets
