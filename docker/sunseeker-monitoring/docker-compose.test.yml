version: '3.8'

services:
  # Test MQTT broker
  test-mqtt:
    image: eclipse-mosquitto:2.0.19
    container_name: test-mqtt-broker
    ports:
      - "1883:1883"
    volumes:
      - ./test-config/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - test-network

  # Test InfluxDB instance
  test-influxdb:
    image: influxdb:2.7.5
    container_name: test-influxdb
    ports:
      - "8087:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=test-user
      - DOCKER_INFLUXDB_INIT_PASSWORD=test-password-12345
      - DOCKER_INFLUXDB_INIT_ORG=test-org
      - DOCKER_INFLUXDB_INIT_BUCKET=test-bucket
      - DOCKER_INFLUXDB_INIT_RETENTION=7d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-influx-token-12345
    networks:
      - test-network

  # Service under test
  sunseeker-service:
    build: .
    container_name: test-sunseeker-service
    depends_on:
      - test-mqtt
      - test-influxdb
    environment:
      - MQTT_URL=mqtt://test-mqtt:1883
      - MQTT_USERNAME=test-client
      - MQTT_PASSWORD=test-password-12345
      - MQTT_DEVICE_ID=test-device-123456789
      - MQTT_APP_ID=test-app-987654321
      - INFLUX_URL=http://test-influxdb:8086
      - INFLUX_TOKEN=test-influx-token-12345
      - INFLUX_ORG=test-org
      - INFLUX_BUCKET=test-bucket
    networks:
      - test-network

  # Integration test runner
  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: test-runner
    depends_on:
      - sunseeker-service
    environment:
      - MQTT_URL=mqtt://test-mqtt:1883
      - INFLUX_URL=http://test-influxdb:8086
      - INFLUX_TOKEN=test-influx-token-12345
      - INFLUX_ORG=test-org
      - INFLUX_BUCKET=test-bucket
      - SERVICE_URL=http://sunseeker-service:8080
    volumes:
      - ./__tests__/integration:/tests
      - ./src/test-constants.js:/tests/test-constants.js
    networks:
      - test-network
    command: npm run test:integration:real

networks:
  test-network:
    driver: bridge